(()=>{"use strict";const e=window.wp.element,t=window.ReactJSXRuntime;async function n(){try{if(!document.requestStorageAccess)return;if("function"!=typeof document.hasStorageAccess||!await document.hasStorageAccess())try{await document.requestStorageAccess()}catch(e){}}catch(e){}}function o(e){const t=window.Eventive;try{if(t&&"function"==typeof t.loginWithToken){const n=t.loginWithToken({eventiveToken:e});return n&&"function"==typeof n.then?n.catch(()=>t.loginWithToken(e)):t.loginWithToken(e)}}catch(e){}return Promise.reject(new Error("Eventive.loginWithToken is unavailable."))}function i({loginLinkText:i,bucket:r}){const[a,s]=(0,e.useState)(!1),[c,l]=(0,e.useState)(!0),[d,v]=(0,e.useState)(!1),[u,h]=(0,e.useState)(""),[m,w]=(0,e.useState)(""),[f,g]=(0,e.useState)(""),[p,y]=(0,e.useState)(""),[k,E]=(0,e.useState)(!1);(0,e.useEffect)(()=>{const e=async()=>{if(window.Eventive&&window.Eventive.isLoggedIn)try{const e=window.Eventive.isLoggedIn();if(s(e),e)try{const e=await window.Eventive.request({method:"GET",path:"people/self",authenticatePerson:!0}),t=e&&(e.person||e);y(t?.first_name||t?.name||t?.full_name||t?.email||"Friend")}catch(e){console.error("Error fetching user info:",e),y("Friend")}else{const e=function(){try{const e=["eventivePersonToken","eventiveAppPersonToken","eventive_token","eventive_person_token"];for(let t=0;t<e.length;t++){const n=localStorage.getItem(e[t]);if(n&&"string"==typeof n&&n.trim())return n.trim()}}catch(e){}return null}();if(e)try{if(await o(e),window.Eventive.isLoggedIn()){s(!0);const e=await window.Eventive.request({method:"GET",path:"people/self",authenticatePerson:!0}),t=e&&(e.person||e);y(t?.first_name||t?.name||t?.full_name||t?.email||"Friend")}}catch(e){}}}catch(e){console.error("Error checking login:",e)}finally{l(!1)}else setTimeout(e,100)};window.Eventive&&window.Eventive.on&&window.Eventive.on("ready",e),e()},[]);const x=()=>{v(!1),h(""),w(""),g("")};return(0,e.useEffect)(()=>{const e=e=>{"Escape"===e.key&&d&&x()};return d&&(document.addEventListener("keydown",e),document.body.style.overflow="hidden"),()=>{document.removeEventListener("keydown",e),document.body.style.overflow=""}},[d]),c?(0,t.jsx)("div",{className:"eventive-login-message",children:"Loading..."}):(0,t.jsxs)("div",{className:"eventive-login",children:[(0,t.jsx)("p",{className:"eventive-login-message",children:a?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("span",{className:"welcome-text",children:["Welcome, ",p,"!"]})," ",(0,t.jsx)("a",{href:"#",onClick:async()=>{try{const e=window.Eventive;if(["eventivePersonToken","eventiveAppPersonToken","eventive_token","eventive_person_token"].forEach(e=>{try{localStorage.removeItem(e)}catch(e){}}),e&&e.request)try{await e.request({method:"POST",path:"people/logout",authenticatePerson:!0})}catch(e){}if(e&&"function"==typeof e.logout)try{const t=e.logout();t&&"function"==typeof t.then&&await t}catch(e){}s(!1),y("");try{window.location.reload()}catch(e){window.location.href=window.location.href}}catch(e){console.error("Logout error:",e)}},className:"logout-link",children:"Log out"})]}):(0,t.jsx)("a",{href:"#",onClick:async e=>{e.preventDefault(),await n(),v(!0),g("")},className:"login-trigger",children:i})}),d&&(0,t.jsx)("div",{className:"eventive-modal-overlay eventive-login-modal",onClick:e=>e.target.classList.contains("eventive-modal-overlay")&&x(),children:(0,t.jsxs)("div",{className:"eventive-modal-panel eventive-modal-panel--small eventive-login-form",children:[(0,t.jsx)("button",{className:"eventive-modal-close-btn",onClick:x,"aria-label":"Close",children:"×"}),(0,t.jsx)("p",{className:"eventive-modal-title",children:"Log in using your Eventive Account"}),(0,t.jsxs)("form",{onSubmit:async e=>{e.preventDefault(),g(""),E(!0);const t=u.trim(),i=m.trim();if(!t||!i)return g("Please enter your email and password."),void E(!1);try{if(!window.Eventive)return g("Eventive is not available"),void E(!1);let e=r;if(e&&""!==e||(e=window.Eventive.event_bucket||window.Eventive.config&&window.Eventive.config.event_bucket||""),!e)return g("Missing event bucket. Please set a default in settings."),void E(!1);const a={email:t,password:i,event_bucket:e};let c;await n();try{const e=await fetch("https://api.eventive.org/people/login",{method:"POST",headers:{"Content-Type":"application/json;charset=UTF-8"},body:JSON.stringify(a)});if(!e.ok){const t=await e.text();throw new Error("Login failed. ("+e.status+") "+(t||"").slice(0,200))}c=await e.json()}catch(e){if(!window.Eventive.request)throw e;c=await window.Eventive.request({method:"POST",path:"people/login",body:a,authenticatePerson:!1})}const l=c&&(c.token||c.person_token);if(!l)throw new Error("No token in response");await o(l);try{localStorage.setItem("evt_last_bucket",String(e||""))}catch(e){}try{const e=await window.Eventive.request({method:"GET",path:"people/self",authenticatePerson:!0}),t=e&&(e.person||e);y(t?.first_name||t?.name||t?.full_name||t?.email||"Friend"),s(!0)}catch(e){y("Friend"),s(!0)}v(!1),h(""),w(""),await n(),setTimeout(()=>{try{window.location.reload()}catch(e){window.location.href=window.location.href}},120)}catch(e){let t="Login failed.";e&&e.status&&(t+=" ("+e.status+")"),e&&e.message&&(t+=" "+e.message),g(t),console.error("Login error:",e)}finally{E(!1)}},children:[(0,t.jsx)("label",{htmlFor:"email",children:"Email"}),(0,t.jsx)("input",{type:"text",id:"email",value:u,onChange:e=>h(e.target.value),required:!0,disabled:k}),(0,t.jsx)("label",{htmlFor:"password",children:"Password"}),(0,t.jsx)("input",{type:"password",id:"password",value:m,onChange:e=>w(e.target.value),required:!0,disabled:k}),f&&(0,t.jsx)("div",{className:"error-message",children:f}),(0,t.jsxs)("div",{className:"button-row",children:[(0,t.jsx)("button",{type:"submit",disabled:k,children:k?"Logging in…":"LOGIN"}),(0,t.jsx)("button",{type:"button",onClick:x,disabled:k,children:"CANCEL"})]})]}),(0,t.jsxs)("div",{className:"eventive-modal-footer",children:[(0,t.jsx)("div",{className:"eventive-footer-note",children:(0,t.jsxs)("a",{href:"https://eventive.org",target:"_blank",rel:"noopener noreferrer",children:["Powered by"," ",(0,t.jsx)("img",{src:"https://festival.eofilmfest.com/img/eventive.png",alt:"Eventive"})]})}),(0,t.jsxs)("div",{children:[(0,t.jsx)("a",{href:"https://eventive.org/terms",target:"_blank",rel:"noopener noreferrer",children:"Terms"})," ","·"," ",(0,t.jsx)("a",{href:"https://eventive.org/privacy",target:"_blank",rel:"noopener noreferrer",children:"Privacy"})," ","·"," ",(0,t.jsx)("a",{href:"https://status.eventive.org/",target:"_blank",rel:"noopener noreferrer",children:"System Status"})]})]})]})})]})}document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".wp-block-eventive-login").forEach(n=>{const o=n.dataset.loginLinkText||"Log in to your account",r=n.dataset.eventBucket||"";(0,e.createRoot)(n).render((0,t.jsx)(i,{loginLinkText:o,bucket:r}))})})})();